name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  build:
    permissions:
      contents: write
    runs-on: windows-2022
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
      with:
        vs-prerelease: true
        
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1.0.5
        
    - name: Download Dalamud Latest
      run: |
        Invoke-WebRequest -Uri https://goatcorp.github.io/dalamud-distrib/latest.zip -OutFile latest.zip
        Expand-Archive -Force latest.zip "$env:AppData\XIVLauncher\addon\Hooks\dev"
        
    - name: Restore NuGet Packages
      run: nuget restore ChatTwo.sln
      
    - name: Build Plugin
      run: msbuild ChatTwo.sln /p:Configuration=Release
      
    - name: Extract Plugin Files
      run: |
        # Find the latest.zip file created by DalamudPackager
        $latestZip = Get-ChildItem -Path "ChatTwo\bin\x64\Release" -Name "latest.zip" -Recurse | Select-Object -First 1
        if ($latestZip) {
          $zipPath = "ChatTwo\bin\x64\Release\$latestZip"
          Write-Host "Found latest.zip at: $zipPath"
          Expand-Archive -Force $zipPath ./Artifact
        } else {
          Write-Host "No latest.zip found, creating manually..."
          New-Item -ItemType Directory -Force -Path Artifact
          Copy-Item "ChatTwo\bin\x64\Release\ChatTwo.dll" Artifact\
          Copy-Item "ChatTwo\bin\x64\Release\ChatTwo.json" Artifact\
          if (Test-Path "ChatTwo\bin\x64\Release\ChatTwo.pdb") {
            Copy-Item "ChatTwo\bin\x64\Release\ChatTwo.pdb" Artifact\
          }
        }
        Get-ChildItem Artifact
        
    - name: Create Release Zip
      run: |
        Compress-Archive -Path Artifact\* -DestinationPath latest.zip
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ github.event.inputs.version }}
        name: Release v${{ github.event.inputs.version }}
        files: |
          latest.zip
          repo.json
        generate_release_notes: true
        token: ${{ secrets.GITHUB_TOKEN }}