name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  build:
    permissions:
      contents: write
    runs-on: windows-2022
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'
        
    - name: Download Dalamud Latest
      run: |
        Invoke-WebRequest -Uri https://goatcorp.github.io/dalamud-distrib/latest.zip -OutFile dalamud.zip
        Expand-Archive -Force dalamud.zip "$env:AppData\XIVLauncher\addon\Hooks\dev"
      
    - name: Build Plugin
      run: dotnet build ChatTwo\ChatTwo.csproj -c Release
      
    - name: Extract Plugin Files
      run: |
        # List all directories to understand the build output structure
        Write-Host "=== Build Output Structure ==="
        Get-ChildItem -Recurse -Directory | Where-Object { $_.Name -eq "Release" } | ForEach-Object { Write-Host $_.FullName }
        
        # Look for built files in common locations
        $possiblePaths = @(
          "ChatTwo\bin\Release\net10.0-windows",
          "ChatTwo\bin\Release",
          "ChatTwo\bin\x64\Release"
        )
        
        $foundPath = $null
        foreach ($path in $possiblePaths) {
          if (Test-Path "$path\GlandeChatTwo.dll") {
            $foundPath = $path
            Write-Host "Found GlandeChatTwo.dll at: $foundPath"
            break
          }
        }
        
        if (-not $foundPath) {
          Write-Host "Searching for GlandeChatTwo.dll in all locations..."
          Get-ChildItem -Recurse -Name "GlandeChatTwo.dll" | ForEach-Object { Write-Host "Found: $_" }
          throw "Could not find GlandeChatTwo.dll in any expected location"
        }
        
        # Create artifact directory and copy files
        New-Item -ItemType Directory -Force -Path Artifact
        Copy-Item "$foundPath\GlandeChatTwo.dll" Artifact\
        Copy-Item "$foundPath\GlandeChatTwo.json" Artifact\
        if (Test-Path "$foundPath\GlandeChatTwo.pdb") {
          Copy-Item "$foundPath\GlandeChatTwo.pdb" Artifact\
        }
        
        # Copy all dependency DLLs that aren't provided by Dalamud
        $dependencies = @(
          "MessagePack.dll",
          "MessagePack.Annotations.dll",
          "Microsoft.Data.Sqlite.dll",
          "SQLitePCLRaw.core.dll",
          "SQLitePCLRaw.provider.e_sqlite3.dll",
          "SQLitePCLRaw.batteries_v2.dll",
          "Pidgin.dll",
          "SixLabors.ImageSharp.dll",
          "Watson.Lite.dll"
        )
        
        foreach ($dep in $dependencies) {
          if (Test-Path "$foundPath\$dep") {
            Copy-Item "$foundPath\$dep" Artifact\
            Write-Host "Copied dependency: $dep"
          }
        }
        
        Write-Host "=== Artifact Contents ==="
        Get-ChildItem Artifact
        
    - name: Create Release Zip
      run: |
        Compress-Archive -Force -Path Artifact\* -DestinationPath latest.zip
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ github.event.inputs.version }}
        name: Release v${{ github.event.inputs.version }}
        files: |
          latest.zip
          repo.json
        generate_release_notes: true
        token: ${{ secrets.GITHUB_TOKEN }}